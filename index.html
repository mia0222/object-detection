<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>物体検知</title>
</head>
<body>
  <canvas id="canvas" width="640" height="480"></canvas>

  <button id="start-button">開始</button>

  <div id="status">起動しています</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow.js/3.15.0/tensorflow.min.js"></script>

  <script>
    // カメラの許可を申請
    const permission = await navigator.permissions.query({
      name: 'camera',
    });

    if (permission.state === 'denied') {
      // カメラへのアクセス権限が許可されていない場合
      alert('カメラへのアクセス権限が許可されていません。設定から許可してください。');
      return;
    }

    // カメラからの画像を読み取る
    const video = await navigator.mediaDevices.getUserMedia({
      video: true,
    });

    // 物体検知を行う
    const model = await tf.loadLayersModel('model.json');

    // ボタンのイベントハンドラ
    const startButton = document.getElementById('start-button');
    startButton.addEventListener('click', () => {
      // カメラからの画像の読み取りと物体検知を開始する
      const tensor = tf.fromPixels(video.toDataURL());
      const detections = model.predict(tensor);

      // 検出した物体を表示する
      for (const detection of detections) {
        const boundingBox = detection.boundingBox;
        const confidence = detection.confidence;

        // 検出した物体の座標と信頼度を表示する
        console.log(boundingBox, confidence);

        // 検出した物体を描画する
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'red';
        ctx.fillRect(boundingBox.x, boundingBox.y, boundingBox.width, boundingBox.height);
      }
    });

    // 起動前は(起動しています)という文字列を表示する
    const status = document.getElementById('status');
    status.textContent = '起動しています';
  </script>
</body>
</html>
